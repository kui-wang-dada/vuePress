<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息队列和事件循环 | 哒哒的博客</title>
    <meta name="description" content="哒哒练习写文章做记录的地方">
    <link rel="icon" href="/blog/img/logo.png">
    
    <link rel="preload" href="/blog/assets/css/0.styles.99707b60.css" as="style"><link rel="preload" href="/blog/assets/js/app.04a40249.js" as="script"><link rel="preload" href="/blog/assets/js/2.614c271f.js" as="script"><link rel="preload" href="/blog/assets/js/5.6030204f.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.4b36cd09.js"><link rel="prefetch" href="/blog/assets/js/11.2d5a8e9e.js"><link rel="prefetch" href="/blog/assets/js/12.5f3cf8ed.js"><link rel="prefetch" href="/blog/assets/js/13.44a80d36.js"><link rel="prefetch" href="/blog/assets/js/14.25295f21.js"><link rel="prefetch" href="/blog/assets/js/15.c62c6c25.js"><link rel="prefetch" href="/blog/assets/js/16.8a80f0bf.js"><link rel="prefetch" href="/blog/assets/js/17.f5d28493.js"><link rel="prefetch" href="/blog/assets/js/18.1dfd5511.js"><link rel="prefetch" href="/blog/assets/js/19.966ec7fb.js"><link rel="prefetch" href="/blog/assets/js/20.f8046668.js"><link rel="prefetch" href="/blog/assets/js/21.b6ee572b.js"><link rel="prefetch" href="/blog/assets/js/22.8be287c5.js"><link rel="prefetch" href="/blog/assets/js/23.0447c120.js"><link rel="prefetch" href="/blog/assets/js/24.ba0460c9.js"><link rel="prefetch" href="/blog/assets/js/25.dd78291e.js"><link rel="prefetch" href="/blog/assets/js/26.3a365eb0.js"><link rel="prefetch" href="/blog/assets/js/27.94f729a2.js"><link rel="prefetch" href="/blog/assets/js/28.b2cbe28d.js"><link rel="prefetch" href="/blog/assets/js/29.4ec1cf2a.js"><link rel="prefetch" href="/blog/assets/js/3.cabfff8b.js"><link rel="prefetch" href="/blog/assets/js/30.efc3e4ac.js"><link rel="prefetch" href="/blog/assets/js/31.8224951a.js"><link rel="prefetch" href="/blog/assets/js/32.6e850d41.js"><link rel="prefetch" href="/blog/assets/js/33.84383827.js"><link rel="prefetch" href="/blog/assets/js/34.b494f796.js"><link rel="prefetch" href="/blog/assets/js/35.ee0a06bd.js"><link rel="prefetch" href="/blog/assets/js/36.a9c9dd98.js"><link rel="prefetch" href="/blog/assets/js/37.5cd39c31.js"><link rel="prefetch" href="/blog/assets/js/38.7f6c4fc2.js"><link rel="prefetch" href="/blog/assets/js/4.b0d7986b.js"><link rel="prefetch" href="/blog/assets/js/6.be32cf31.js"><link rel="prefetch" href="/blog/assets/js/7.c65ec4e3.js"><link rel="prefetch" href="/blog/assets/js/8.7f5e33b9.js"><link rel="prefetch" href="/blog/assets/js/9.e1c65847.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.99707b60.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">哒哒的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JS基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JS/object.html" class="nav-link">JS之面向对象程序设计和继承</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/write.html" class="nav-link">手写代码系列</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/base.html" class="nav-link">JS基础知识总结</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/copy.html" class="nav-link">JS深浅拷贝</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/design.html" class="nav-link">JS设计模式</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/this.html" class="nav-link">JS之this指向</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/ifelse.html" class="nav-link">JS条件语句</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/simple.html" class="nav-link">JS之代码简洁之道</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架+App</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/app/vue.html" class="nav-link">vue基础知识</a></li><li class="dropdown-item"><!----> <a href="/blog/app/vuex.html" class="nav-link">vuex基础</a></li><li class="dropdown-item"><!----> <a href="/blog/app/cordova.html" class="nav-link">cordova基础</a></li><li class="dropdown-item"><!----> <a href="/blog/app/vueCordova.html" class="nav-link">vue+cordova思考</a></li><li class="dropdown-item"><!----> <a href="/blog/app/RNSummary.html" class="nav-link">ReactNative技术栈总结</a></li><li class="dropdown-item"><!----> <a href="/blog/app/RNRecord.html" class="nav-link">ReactNative知识点记录</a></li><li class="dropdown-item"><!----> <a href="/blog/app/flutter_1.html" class="nav-link">flutter学习笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/app/uniapp.html" class="nav-link">小程序多端框架研究</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Node/koa2.html" class="nav-link">koa2+sequelize初探</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/fullStack.html" class="nav-link">全栈工程思考</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">浏览器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/http.html" class="nav-link">http协议总结</a></li><li class="dropdown-item"><!----> <a href="/blog/web/web_1.html" class="nav-link">浏览器的执行顺序和结构1</a></li><li class="dropdown-item"><!----> <a href="/blog/web/web_2.html" class="nav-link router-link-exact-active router-link-active">浏览器的执行顺序和结构2</a></li><li class="dropdown-item"><!----> <a href="/blog/web/font-end.html" class="nav-link">前端转行心得</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">构建</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/goujian/webpack.html" class="nav-link">webpack学习</a></li><li class="dropdown-item"><!----> <a href="/blog/goujian/cli.html" class="nav-link">从零搭建一个脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/goujian/docker.html" class="nav-link">docker学习笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/base/computer.html" class="nav-link">计算机基础</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JS基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JS/object.html" class="nav-link">JS之面向对象程序设计和继承</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/write.html" class="nav-link">手写代码系列</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/base.html" class="nav-link">JS基础知识总结</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/copy.html" class="nav-link">JS深浅拷贝</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/design.html" class="nav-link">JS设计模式</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/this.html" class="nav-link">JS之this指向</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/ifelse.html" class="nav-link">JS条件语句</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/simple.html" class="nav-link">JS之代码简洁之道</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架+App</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/app/vue.html" class="nav-link">vue基础知识</a></li><li class="dropdown-item"><!----> <a href="/blog/app/vuex.html" class="nav-link">vuex基础</a></li><li class="dropdown-item"><!----> <a href="/blog/app/cordova.html" class="nav-link">cordova基础</a></li><li class="dropdown-item"><!----> <a href="/blog/app/vueCordova.html" class="nav-link">vue+cordova思考</a></li><li class="dropdown-item"><!----> <a href="/blog/app/RNSummary.html" class="nav-link">ReactNative技术栈总结</a></li><li class="dropdown-item"><!----> <a href="/blog/app/RNRecord.html" class="nav-link">ReactNative知识点记录</a></li><li class="dropdown-item"><!----> <a href="/blog/app/flutter_1.html" class="nav-link">flutter学习笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/app/uniapp.html" class="nav-link">小程序多端框架研究</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Node/koa2.html" class="nav-link">koa2+sequelize初探</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/fullStack.html" class="nav-link">全栈工程思考</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">浏览器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/http.html" class="nav-link">http协议总结</a></li><li class="dropdown-item"><!----> <a href="/blog/web/web_1.html" class="nav-link">浏览器的执行顺序和结构1</a></li><li class="dropdown-item"><!----> <a href="/blog/web/web_2.html" class="nav-link router-link-exact-active router-link-active">浏览器的执行顺序和结构2</a></li><li class="dropdown-item"><!----> <a href="/blog/web/font-end.html" class="nav-link">前端转行心得</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">构建</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/goujian/webpack.html" class="nav-link">webpack学习</a></li><li class="dropdown-item"><!----> <a href="/blog/goujian/cli.html" class="nav-link">从零搭建一个脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/goujian/docker.html" class="nav-link">docker学习笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/base/computer.html" class="nav-link">计算机基础</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>消息队列和事件循环</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web/web_2.html#消息队列和事件循环" class="sidebar-link">消息队列和事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web/web_2.html#宏任务微任务" class="sidebar-link">宏任务微任务</a></li><li class="sidebar-sub-header"><a href="/blog/web/web_2.html#promise" class="sidebar-link">Promise</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="消息队列和事件循环"><a href="#消息队列和事件循环" aria-hidden="true" class="header-anchor">#</a> 消息队列和事件循环</h2> <blockquote><p>每一个渲染进程都有一个主线程，既要处理 DOM，又要计算样式，还要处理布局，同时还需要处理 js 任务以及各种输入事件。要让这么多不同类型的任务在主线程中有条不紊执行，需要一个系统来统筹调度，这个系统就是消息队列和事件循环系统</p></blockquote> <p>队列：先进先出</p> <p><img src="/blog/assets/img/62.e2582e98.png" alt="1.jpeg"></p> <ul><li>一个消息队列用来调度任务，接收其他线程的任务</li> <li>IO 线程用来接收其他进程产生的任务</li> <li>渲染主线程会循环的从消息队列头部中读取任务，执行任务</li></ul> <p><strong>消息队列中的任务类型</strong></p> <ul><li>输入事件（鼠标滚动、点击、移动）</li> <li>微任务</li> <li>文件读写</li> <li>websocket</li> <li>js 定时器</li> <li>js 执行，解析 DOM，样式计算，布局计算，css 动画</li></ul> <h3 id="宏任务微任务"><a href="#宏任务微任务" aria-hidden="true" class="header-anchor">#</a> 宏任务微任务</h3> <p>消息队列中的任务执行过程中，会产生新的任务，如果将这些新产生的任务添加到消息队列尾部，那么这些任务会丧失实时性，如果任务直接出发，阻断当前任务的执行，又会影响当前任务的执行效率</p> <p>所以最好的时机是：当前任务执行完，下个任务开始前；</p> <p>eg: dom 节点的监控；</p> <blockquote><p>消息队列中的任务称为宏任务，每个宏任务都包含了一个微任务队列，在执行宏任务的过程中，产生的微任务会添加到列表中，当宏任务主要功能执行完后，会执行当前宏任务的微任务列表</p></blockquote> <p><strong>宏任务</strong></p> <ul><li>渲染事件（如解析 DOM、计算布局、绘制）</li> <li>用户交互事件（如鼠标点击、滚动页面、放大缩小等）</li> <li>JavaScript 脚本执行事件</li> <li>网络请求完成、文件读写完成事件</li></ul> <p>宏任务可以满足我们大部分的日常需求，不过如果有对时间精度要求较高的要求，宏任务就难以胜任了。
页面的渲染事件、各种 IO 的完成事件、执行 js 脚本的事件、用户交互的事件等都随时有可能被添加到消息队列中，而且添加事件是由系统操作的，js 代码不能准确掌控任务要添加到队列中的位置，因此很难控制开始执行任务的时间。</p> <p><strong>微任务</strong></p> <blockquote><p>微任务就是一个需要异步执行的函数，执行时机是在主函数执行结束之后、当前宏任务结束之前</p></blockquote> <ol><li><p>微任务的产生</p> <ul><li><p>使用 MutationObserver 监控某个 DOM 节点，通过 JS 修改这个节点，当 DOM 发生变化时，就会产生 DOM 变化记录的微任务</p></li> <li><p>Promise，当调用 Promise.resolve()或者 reject 时</p></li></ul></li> <li><p>微任务的执行</p> <ul><li><p>宏任务快执行完成时，也就在 js 引擎准备退出全局执行上下文并清空调用栈的时候，js 会检查全局执行上下文的微任务队列</p></li> <li><p>在执行微任务的过程中，产生了新的微任务，同样会将该微任务添加到微任务队列中，v8 引擎一直循环执行微任务队列中的任务，直到队列为空才算执行结束</p></li></ul></li></ol> <p><img src="/blog/assets/img/63.839f468b.png" alt="2.jpeg"></p> <ul><li>微任务和宏任务是绑定的，每个宏任务执行时，会创建自己的微任务队列</li> <li>微任务的执行时长会影响到当前宏任务的时长。</li> <li>在一个宏任务中，分别创建一个用于回调的宏任务和微任务，无论什么情况，微任务都早于宏任务执行</li></ul> <h3 id="promise"><a href="#promise" aria-hidden="true" class="header-anchor">#</a> Promise</h3> <blockquote><p>单线程架构决定了 web 页面的异步回调，而多次回调会导致代码的逻辑不连贯、不线性。Promise 封装异步代码，让处理流程变得线性</p></blockquote> <p><img src="/blog/assets/img/64.83dd5231.png" alt="3.jpeg"></p> <p>我们来看一下 Promise 的常用用法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'url'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">ontimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>

a<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>观察上面代码，可以发现：</p> <ul><li>构建 Promise 对象时，需要传入一个 b 函数，业务流程都在 b 函数中执行</li> <li>如果运行 b 函数中的业务执行成功了，会调用 resolve 函数；如果执行失败，则调用 reject 函数</li> <li>在 b 函数中调用 resolve 函数时，会触发 Promise.then 中设置的回调函数;调用 reject 函数时，会触发 Promise.catch 设置的回调函数</li></ul> <p><strong>首先，Promise 实现了回调函数的延时绑定</strong>
其在代码上的提现就是先创建了 Promise，执行业务逻辑；再使用 then 来设置回调函数。resolve 函数会触发设置的回调函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

a<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onResolve<span class="token punctuation">)</span>
</code></pre></div><p><strong>其次，需要将回调函数 onResolve 的返回值穿透到最外层</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> a2 <span class="token comment">//then的返回值也是一个promise</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就可以实现透传：a.then().then(value);实现透传之后，Promise 对象的错误就具有冒泡性质，会一直向后传递，知道被 catch</p> <p><strong>我们来实现一个简易版 Promise</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
<span class="token keyword">const</span> <span class="token constant">RESOLVED</span> <span class="token operator">=</span> <span class="token string">'resolved'</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>

<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>resolveCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>rejectCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//   这个地方实际用的是微任务，目的是让then中的回调先执行</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        that<span class="token punctuation">.</span>resolveCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">item</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    同上
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 简易版</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token comment">//   简易的透传，cb不存在时</span>
  cb <span class="token operator">=</span> <span class="token keyword">typeof</span> cb <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">cb</span> <span class="token punctuation">:</span> <span class="token parameter">v</span> <span class="token operator">=&gt;</span> v
  <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    that<span class="token punctuation">.</span>resolvedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// then函数返回Promise</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      that<span class="token punctuation">.</span>resolvedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">//此时执行了then1的回调</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">//返回上一步的返回值</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/3/2020, 8:53:34 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.04a40249.js" defer></script><script src="/blog/assets/js/2.614c271f.js" defer></script><script src="/blog/assets/js/5.6030204f.js" defer></script>
  </body>
</html>
